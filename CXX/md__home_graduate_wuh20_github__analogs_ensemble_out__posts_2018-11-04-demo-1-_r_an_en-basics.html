<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AnalogEnsemble: 2018-11-04-demo-1-RAnEn-basics</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AnalogEnsemble
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">2018-11-04-demo-1-RAnEn-basics </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><hr/>
<p> layout: post title: Basics of RAnEn tags: </p><h2>- tutorial </h2>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#data-description">Data Description</a></li>
<li><a href="#generate-temperature-forecasts">Generate Temperature Forecasts</a></li>
<li><a href="#visualization">Visualization</a></li>
</ul>
<h2>Introduction </h2>
<p>This article walks you through the basic usage of the <code>RAnEn</code> library in a practice of short-term surface temperature forecasts. Data are prepared using the <code>generate-data.R</code> script, and collected from <a href="https://www.ncdc.noaa.gov/data-access/model-data/model-datasets/north-american-mesoscale-forecast-system-nam">North American Mesoscale Forecast System (NAM)</a>.</p>
<p>You will learn how to use these functions:</p>
<ul>
<li><code>generateConfiguration</code></li>
<li><code>generateAnalogs</code></li>
<li><code>biasCorrection</code></li>
</ul>
<h2>Data Description </h2>
<p>First, let's load the prepared NAM model forecasts and analysis.</p>
<div class="fragment"><div class="line">load(&#39;analysis.RData&#39;)</div><div class="line">load(&#39;forecasts.RData&#39;)</div><div class="line">print(ls())</div></div><!-- fragment --> <pre class="fragment">##  [1] "analysis"               "analysis.circular.pars"
##  [3] "analysis.indices"       "analysis.par.names"    
##  [5] "analysis.times"         "analysis.xs"           
##  [7] "analysis.ys"            "flts"                  
##  [9] "forecast.circular.pars" "forecast.indices"      
## [11] "forecast.par.names"     "forecast.times"        
## [13] "forecast.xs"            "forecast.ys"           
## [15] "forecasts"
</pre><p>In total, 10 parameters are provided in the forecast data set.</p>
<div class="fragment"><div class="line">print(forecast.par.names)</div></div><!-- fragment --> <pre class="fragment">##  [1] "SurfaceTemperature"         "TropoWindU"                
##  [3] "TropoWindV"                 "SurfacePressure"           
##  [5] "TotalCloudCover"            "TotalPrecipitation"        
##  [7] "DownwardShortWaveRadiation" "DownwardLongWaveRadiation" 
##  [9] "UpwardShortWaveRadiation"   "UpwardLongWaveRadiation"
</pre><p>Foreacsts and analysis have the following time range.</p>
<div class="fragment"><div class="line">print(range(forecast.times))</div></div><!-- fragment --> <pre class="fragment">## [1] "2017-01-01 UTC" "2018-07-31 UTC"
</pre><div class="fragment"><div class="line">print(range(analysis.times))</div></div><!-- fragment --> <pre class="fragment">## [1] "2017-01-01 00:00:00 UTC" "2018-07-31 06:00:00 UTC"
</pre><p>Coordinates in lat/lon are provided for grid points. We can plot them on maps. Note that coordinates start from the bottom left grid point and proceed in a row-wise order. There are 11 rows and 11 columns of grid points in the data sets.</p>
<div class="fragment"><div class="line">map(&#39;state&#39;, regions = c(&#39;pennsylvania&#39;, &#39;new york&#39;, &#39;virginia&#39;), col = &#39;grey&#39;)</div><div class="line">map(&#39;usa&#39;, add = T)</div><div class="line">points(forecast.xs - 360, forecast.ys, pch = 16, cex = .3, col = &#39;red&#39;)</div></div><!-- fragment --><div class="image">
<img src="https://github.com/Weiming-Hu/AnalogsEnsemble/raw/gh-pages/assets/posts/2018-11-04-demo-1-RAnEn-basics/geography.jpg" alt="Geography of the region of interest"/>
</div>
<p>Finally, let's look at the dimensions of forecasts and analysis.</p>
<div class="fragment"><div class="line">print(dim(forecasts))</div></div><!-- fragment --> <pre class="fragment">## [1]  10 121 576  36
</pre><div class="fragment"><div class="line">print(dim(analysis))</div></div><!-- fragment --> <pre class="fragment">## [1]   10  121 2805
</pre><p><a class="el" href="class_forecasts.html" title="Forecasts class provides interface for reading and writing forecast data from and to a NetCDF file...">Forecasts</a> have 4 dimensions. They are parameters, stations/grid points, days, and Forecast Lead Times (FLTs). Analysis have 3 dimensions. They are parameters, stations/grid points, and time.</p>
<h2>Generate Temperature <a class="el" href="class_forecasts.html" title="Forecasts class provides interface for reading and writing forecast data from and to a NetCDF file...">Forecasts</a> </h2>
<p>Now that we have a general idea of the data, we can generate temperature forecasts. The steps to generate <a class="el" href="class_an_en.html" title="AnEn class provides interfaces for computing Analog Ensembles. ">AnEn</a> forecasts are as follow:</p>
<ul>
<li>Initialize a configuration</li>
<li>Set up options</li>
<li>Generate <a class="el" href="class_an_en.html" title="AnEn class provides interfaces for computing Analog Ensembles. ">AnEn</a></li>
</ul>
<p>First, we set up the configuration. We generate <a class="el" href="class_an_en.html" title="AnEn class provides interfaces for computing Analog Ensembles. ">AnEn</a> for one day using about one year of historical data for all the grid points available. If you don't understand any of the options, please see the <a href="https://weiming-hu.github.io/AnalogsEnsemble/R/reference/generateConfiguration.html">document</a>.</p>
<p>Now we can generate <a class="el" href="class_an_en.html" title="AnEn class provides interfaces for computing Analog Ensembles. ">AnEn</a>.</p>
<div class="fragment"><div class="line">AnEn &lt;- generateAnalogs(config)</div></div><!-- fragment --> <pre class="fragment">## Convert R objects to C++ objects ...
## Wrapping C++ object mapping ...
## Wrapping C++ object analogs ...
## Done!
</pre><p>Then we need to bias correct <a class="el" href="class_an_en.html" title="AnEn class provides interfaces for computing Analog Ensembles. ">AnEn</a> because we are using <a class="el" href="class_an_en.html" title="AnEn class provides interfaces for computing Analog Ensembles. ">AnEn</a> on a gridded product.</p>
<div class="fragment"><div class="line">AnEn &lt;- biasCorrection(AnEn, config, forecast.ID = 1, group.func = mean,</div><div class="line">                       na.rm = T, show.progress = F)</div></div><!-- fragment --><p><code><a class="el" href="class_an_en.html" title="AnEn class provides interfaces for computing Analog Ensembles. ">AnEn</a></code> is a list of results. Let's check what we have in it.</p>
<div class="fragment"><div class="line">print(AnEn)</div></div><!-- fragment --> <pre class="fragment">## Class: AnEn list
## Member 'analogs': [test station][test time][FLT][member][type]
## 121 1 36 19 3 (value, search station, search observation time)
## Member 'mapping': [FLT][forecast time] 36 370
## Member 'analogs.cor.insitu': [test station][test time][FLT][member][type]
## 121 1 36 19 3 (value, search station, search observation time)
</pre><h2>Visualization </h2>
<p>Finally, we can plot together the analysis, the forecasts, the <a class="el" href="class_an_en.html" title="AnEn class provides interfaces for computing Analog Ensembles. ">AnEn</a>, and the bias corrected <a class="el" href="class_an_en.html" title="AnEn class provides interfaces for computing Analog Ensembles. ">AnEn</a>. Below the figures are the respective RMSE.</p>
<div class="fragment"><div class="line"># Choose a FLT to plot</div><div class="line">i.flt &lt;- 31</div><div class="line"></div><div class="line"># Calculate ensemble means</div><div class="line">mean.analogs &lt;- apply(AnEn$analogs[, , , , 1, drop = F], c(1, 2, 3), mean, na.rm = T)</div><div class="line">mean.analogs.cor &lt;- apply(AnEn$analogs.cor[, , , , 1, drop = F], c(1, 2, 3), mean, na.rm = T)</div><div class="line"></div><div class="line"># Create an empty raster for the geographical region</div><div class="line">xy &lt;- cbind(as.numeric(forecast.xs) - 360, as.numeric(forecast.ys))</div><div class="line">colnames(xy) = c(&#39;x&#39;, &#39;y&#39;)</div><div class="line">ext &lt;- extent(xy[, c(&#39;x&#39;, &#39;y&#39;)])</div><div class="line">rast &lt;- raster(ext, nrow = 11, ncol = 11, crs = CRS(&quot;+proj=longlat +datum=WGS84&quot;))</div><div class="line"></div><div class="line"># Rasterize the data values</div><div class="line">rast.anen &lt;- rasterize(xy[, c(&#39;x&#39;, &#39;y&#39;)], rast, mean.analogs[, 1, i.flt], fun = mean)</div><div class="line">rast.anen.cor &lt;- rasterize(xy[, c(&#39;x&#39;, &#39;y&#39;)], rast, mean.analogs.cor[, 1, i.flt], fun = mean)</div><div class="line">rast.fcts &lt;- rasterize(xy[, c(&#39;x&#39;, &#39;y&#39;)], rast, forecasts[1, , test.start, i.flt], fun = mean)</div><div class="line">rast.anly &lt;- rasterize(xy[, c(&#39;x&#39;, &#39;y&#39;)], rast, analysis[</div><div class="line">  1, , which(analysis.times == forecast.times[test.start] + flts[i.flt])], fun = mean)</div><div class="line"></div><div class="line"># Calculate RMSE</div><div class="line">rmse.fcts &lt;- sqrt(mean((values(rast.fcts - rast.anly))^2, na.rm = T))</div><div class="line">rmse.anen &lt;- sqrt(mean((values(rast.anen - rast.anly))^2, na.rm = T))</div><div class="line">rmse.anen.cor &lt;- sqrt(mean((values(rast.anen.cor - rast.anly))^2, na.rm = T))</div><div class="line"></div><div class="line"># Create a color scale with 100 colors</div><div class="line">cols &lt;- colorRampPalette(brewer.pal(11, &#39;Spectral&#39;)[11:1])(100)</div><div class="line"></div><div class="line"># Define value limit</div><div class="line">zlim &lt;- range(c(values(rast.fcts), values(rast.anen),</div><div class="line">                values(rast.anly), values(rast.anen.cor)),</div><div class="line">              na.rm = T)</div><div class="line"># Visualization</div><div class="line">par(mfrow = c(2, 2), mar = c(4, 1, 3, 3))</div><div class="line">plot(rast.anly, main = &#39;NAM Analysis&#39;, col = cols, zlim = zlim, legend = F)</div><div class="line">map(col = &#39;grey&#39;, add = T); map(&#39;state&#39;, add = T)</div><div class="line">plot(rast.fcts, main = &#39;NAM Forecasts&#39;, col = cols, zlim = zlim,</div><div class="line">     xlab = paste(&#39;RMSE =&#39;, round(rmse.fcts, 4)))</div><div class="line">map(col = &#39;grey&#39;, add = T); map(&#39;state&#39;, add = T)</div><div class="line">plot(rast.anen, main = &#39;AnEn Averaged&#39;, col = cols, zlim = zlim,</div><div class="line">     legend = F, xlab = paste(&#39;RMSE =&#39;, round(rmse.anen, 4)))</div><div class="line">map(col = &#39;grey&#39;, add = T); map(&#39;state&#39;, add = T)</div><div class="line">plot(rast.anen.cor, main = &#39;Bias Corrected AnEn Averaged&#39;, col = cols,</div><div class="line">     zlim = zlim, xlab = paste(&#39;RMSE =&#39;, round(rmse.anen.cor, 4)))</div><div class="line">map(col = &#39;grey&#39;, add = T); map(&#39;state&#39;, add = T)</div></div><!-- fragment --><div class="image">
<img src="https://github.com/Weiming-Hu/AnalogsEnsemble/raw/gh-pages/assets/posts/2018-11-04-demo-1-RAnEn-basics/results.jpg" alt="Result comparison"/>
</div>
 </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
