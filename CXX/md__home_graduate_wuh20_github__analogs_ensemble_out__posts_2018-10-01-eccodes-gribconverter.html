<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AnalogEnsemble: 2018-10-01-eccodes-gribconverter</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AnalogEnsemble
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">2018-10-01-eccodes-gribconverter </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><hr/>
<p> layout: post title: How to use Eccodes Tools and the <a class="el" href="namespacegrib_converter.html">gribConverter</a> Tool tags: </p><h2>- tutorial </h2>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#preparation">Preparation</a><ul>
<li><a href="#gribconverter">gribConverter</a></li>
<li><a href="#eccodes">Eccodes</a></li>
</ul>
</li>
<li><a href="#usage">Usage</a><ul>
<li><a href="#extract-time-and-flts">Extract Time and FLTs</a></li>
<li><a href="#specifying-parameters">Specifying Parameters</a></li>
</ul>
</li>
<li><a href="#example">Example</a></li>
<li><a href="#caveat">Caveat</a></li>
<li><a href="#summary">Summary</a></li>
</ul>
<h2>Introduction</h2>
<p>The <code><a class="el" href="namespacegrib_converter.html">gribConverter</a></code> tool provided in this package offers the convenience for converting GRB2 files to NetCDF files. The produced NetCDF files should be ready to be read into Analog computing tools like <code>similarityCalculator</code>. This post demonstrates how to use <code>Eccodes</code> tools and the <code><a class="el" href="namespacegrib_converter.html">gribConverter</a></code> together to complete the file conversion task.</p>
<h2>Preparation</h2>
<h4><a class="el" href="namespacegrib_converter.html">gribConverter</a></h4>
<p><code><a class="el" href="namespacegrib_converter.html">gribConverter</a></code> is by default not built, because it depends on the <a href="https://confluence.ecmwf.int/display/ECC/ecCodes+Home">ECMWF ecCodes library</a>.</p>
<p>To build <code><a class="el" href="namespacegrib_converter.html">gribConverter</a></code>, you can specify the parameter to <code>CMake</code>.</p>
<div class="fragment"><div class="line">cmake -DBUILD_GRIBCONVERTER=ON ..</div><div class="line"></div><div class="line"># If the eccodes library cannot be found, try to tell where it is explicitly</div><div class="line">cmake -DBUILD_GRIBCONVERTER=ON -CMAKE_PREFIX_PATH=&lt;path to eccodes&gt; ..</div></div><!-- fragment --><p>The library <code>eccodes</code> will be automatically built by default if <code><a class="el" href="namespacegrib_converter.html">gribConverter</a></code> is built. However, in cases of failure during building <code>eccodes</code>, please install the library using your preferred package management tool, for example, <code>HomeBrew</code> on Mac OS or <code>apt-get</code> on Debian.</p>
<p>More details please see <a href="https://weiming-hu.github.io/AnalogsEnsemble/#installation">the documentation</a></p>
<h4>Eccodes</h4>
<p>Please install <a href="https://confluence.ecmwf.int/display/ECC/ecCodes+Home">ECMWF ecCodes library</a> using your preferred package management tools. Upon successful installation, you should have the following tools available:</p>
<ul>
<li>grib_ls</li>
<li>grib_get_data</li>
<li>...</li>
</ul>
<h2>Usage</h2>
<p>I have prepared a GRB2 file downloaded from <a href="https://www.ncdc.noaa.gov/data-access/model-data/model-datasets/north-american-mesoscale-forecast-system-nam">NAM Forecast System</a>. It can be accessed <a href="https://weiming.ddns.net/nextcloud/index.php/s/9QS4YJPDAirjtoM">here</a>(54.6 MB).</p>
<p><code><a class="el" href="namespacegrib_converter.html">gribConverter</a></code> reads from all files found in the folder specifed by arguments <code>folder</code> and <code>ext</code>. It assumes that the time and the Forecast Lead Time (FLT) information comes from the file name. In the case of the example data file, the file name is <code>nam_218_20180701_0000_000.grb2</code>. <code>20180701</code> is the date (time) information, <code>0000</code> is the model cycle time information, and <code>000</code> is the forecast lead time. Later on, we are going to extract the needed information using regular expression.</p>
<p>For parameter information, <code><a class="el" href="namespacegrib_converter.html">gribConverter</a></code> will try to read them from the file according to the input arguments.</p>
<p>For station information, <code><a class="el" href="namespacegrib_converter.html">gribConverter</a></code> automatically reads lat/lon or x/y from the file.</p>
<h4>Extract Time and FLTs</h4>
<p>In order to extract time information from the file name, we use the following regular expression.</p>
<div class="fragment"><div class="line">.*nam_218_(\d{8})_\d{4}_\d{3}\.grb2$</div></div><!-- fragment --><p><code>.*</code> means to match any character 0 or more times. <code>\d{8}</code> means to match numeric digit exactly 8 times. When it is enclosed by a pair of parenthesis, it shows that this string of number is what we need. In this case, the 8-digit number is what we need for time information. Sometimes, if the string is delimited, for example <code>2018-09-01</code>, you can use the option <code>--delimited</code> to solve the problem. The program should automatically detect the dilimiter.</p>
<p>Same story to extract FLT information.</p>
<div class="fragment"><div class="line">.*nam_218_\d{8}_\d{4}_(\d{3})\.grb2$</div></div><!-- fragment --><p>We only changed the location of parenthesis, because the 3-digit number is what we need for the FLT information. Please pay attention to the options <code>flt-interval</code>. This is the number of seconds between two forecast lead times. For example, in the case of an hourly forecasts, this should be 60 * 60 = 3600.</p>
<p><b>I recommend specifying the regular expression in a configuration file in stead of in commandline options to avoid worrying about escaping characters.</b></p>
<h4>Specifying Parameters</h4>
<p>In order for the program to know exactly which parameters you want to extract from the GRB2 file and wirte into a NetCDF file, we need to specify three attributes of a parameter:</p>
<ul>
<li>pars-id</li>
<li>levels</li>
<li>level-types</li>
</ul>
<p>These information can be found using the <code>eccodes</code> tool <code>grib_ls</code>.</p>
<p>To print out all the available parameters in the file, you can type the following commands:</p>
<div class="fragment"><div class="line">&gt; grib_ls -p paramId,level,typeOfLevel,name nam_218_20180701_0000_000.grb2 | head -20</div><div class="line">nam_218_20180701_0000_000.grb2</div><div class="line">paramId      level        typeOfLevel  name         </div><div class="line">260074       0            meanSea      Pressure reduced to MSL </div><div class="line">260389       1            hybrid       Derived radar reflectivity </div><div class="line">260390       0            unknown      Maximum/Composite radar reflectivity </div><div class="line">3020         0            surface      Visibility  </div><div class="line">3020         0            cloudTop     Visibility  </div><div class="line">260190       1            hybrid       Blackadar mixing length scale </div><div class="line">156          0            unknown      Geopotential Height </div><div class="line">131          0            unknown      U component of wind </div><div class="line">132          0            unknown      V component of wind </div><div class="line">7001353      0            unknown      Ventilation Rate </div><div class="line">260065       0            surface      Wind speed (gust) </div><div class="line">0            0            unknown      unknown     </div><div class="line">260238       5            isobaricInhPa  Geometric vertical velocity </div><div class="line">260238       10           isobaricInhPa  Geometric vertical velocity </div><div class="line">260238       20           isobaricInhPa  Geometric vertical velocity </div><div class="line">156          50           isobaricInhPa  Geopotential Height </div><div class="line">130          50           isobaricInhPa  Temperature </div><div class="line">157          50           isobaricInhPa  Relative humidity </div></div><!-- fragment --><p><code>-p paraId,level,typeOfLevel,name</code> tells the program to print out only these attributes. <code>| head -20</code> is optional, telling the program to print out only the first 10 lines.</p>
<p>You can also find more information for a variable using the <a href="http://apps.ecmwf.int/codes/grib/param-db/">ECMWF GRIB Parameter database</a>. This is a list of parameters that <code>grib_ls</code> will recognize.</p>
<p>You have two ways to specify parameters in <code><a class="el" href="namespacegrib_converter.html">gribConverter</a></code>.</p>
<p>In commandline options:</p>
<div class="fragment"><div class="line"># All options should be in order</div><div class="line">--pars-id=156 131 --levels=0 0 ---level-types=unknown unknown</div></div><!-- fragment --><p>In a configuration file</p>
<div class="fragment"><div class="line"># Parameter 156</div><div class="line">pars-id = 156</div><div class="line">levels = 0</div><div class="line">level-types=unknown</div><div class="line">parameters-new-name = 156_0</div><div class="line"></div><div class="line"># Parameter 131</div><div class="line">pars-id = 131</div><div class="line">levels = 0</div><div class="line">level-types=unknown</div><div class="line">parameters-new-name = 131_0</div></div><!-- fragment --><p>** Multiple input on a single line is not supported in configuration files**</p>
<h2>Example</h2>
<p>An working example can be found <a href="https://github.com/Weiming-Hu/AnalogsEnsemble/tree/master/apps/app_gribConverter/example">here</a>.</p>
<ul>
<li>commonConfig.cfg is the common configuration file that all files share. It includes basic options like parameters, times, and flts;</li>
<li>convertForecasts.sh is the script specifying the different options for files, includes <code>output</code> and <code>folder</code>.</li>
</ul>
<h2>Caveat</h2>
<p>Please note in the file <code>convertForecasts.sh</code> on <a href="https://github.com/Weiming-Hu/AnalogsEnsemble/blob/2ab0a1a5049917a1c55ef258cc725bb63fe6b780/apps/app_gribConverter/example/convertForecasts.sh#L3">line 3</a>, I specified the number of threads to be created in the program. It is NOT the case that the more threads you create the faster your program will run. This also depends on your network quality. Because when too many threads are created, it actually slows download the file transfer process. For my case where the maximum network speed can go up until ~30 MB/s, I found that when I created more than 5 threads, it will slow down the network. Therefore, I tested with creating 1, 2, 3, and 5 threads, and decided I should only create 3 which should be a fairly balanced point.</p>
<h2>Summary</h2>
<p>This post explains the typical way to use the <code>girbConverter</code>. There are some options not covered in this article, please refered to <code><a class="el" href="namespacegrib_converter.html">gribConverter</a> --help</code>.</p>
<p>Please report any issues <a href="https://github.com/Weiming-Hu/AnalogsEnsemble/issues">here</a>. Thank you.</p>
<div class="fragment"><div class="line"># &quot;`-&#39;&#39;-/&quot;).___..--&#39;&#39;&quot;`-._</div><div class="line">#  (`6_ 6  )   `-.  (     ).`-.__.`)   WE ARE ...</div><div class="line">#  (_Y_.)&#39;  ._   )  `._ `. ``-..-&#39;    PENN STATE!</div><div class="line">#    _ ..`--&#39;_..-_/  /--&#39;_.&#39; ,&#39;</div><div class="line">#  (il),-&#39;&#39;  (li),&#39;  ((!.-&#39;</div><div class="line"># </div><div class="line"># Author: Weiming Hu &lt;weiming@psu.edu&gt;</div><div class="line">#         </div><div class="line"># Geoinformatics and Earth Observation Laboratory (http://geolab.psu.edu)</div><div class="line"># Department of Geography and Institute for CyberScience</div><div class="line"># The Pennsylvania State University</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
