<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ParallelAnalogEnsemble: 2019-03-01-using-gribConverter-on-cheyenne</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ParallelAnalogEnsemble
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">2019-03-01-using-gribConverter-on-cheyenne </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><hr/>
<p> layout: post title: How to Automate Data Preprocessing for <a class="el" href="class_an_en.html" title="AnEn is an abstract class that defines the interface for implement analog ensemble generation...">AnEn</a> Computation on Cheyenne tags:</p><ul>
<li>tutorial <h2>- gribConverter </h2>
</li>
</ul>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#data-preparation">Data Preparation</a></li>
<li><a href="#scripts">Scripts</a></li>
<li><a href="#results">Results</a></li>
<li><a href="#appendix">Appendix</a></li>
</ul>
<h2>Introduction</h2>
<p>This tutorial shows how to use the data preprocessing tools (<code>gribConverter</code>, <code>windFieldCalculator</code>) in the <a class="el" href="class_an_en.html" title="AnEn is an abstract class that defines the interface for implement analog ensemble generation...">AnEn</a> package to reformat the data to the correct form that can be directly used by a number of computation tools (<code>similarityCalculator</code>, <code>analogGenerator</code>, <code>RAnEn</code>) to generate analog ensembles. Addition to that, this tutorial also shows how to automate and parallelize the process on Cheyenne supercomputers.</p>
<p>This tutorial assumes the basic knowledge on bash script language and that <code><a class="el" href="class_an_en.html" title="AnEn is an abstract class that defines the interface for implement analog ensemble generation...">AnEn</a></code> package has already been successfully installed. More information of how to install <code><a class="el" href="class_an_en.html" title="AnEn is an abstract class that defines the interface for implement analog ensemble generation...">AnEn</a></code> on Cheyenne can be found <a href="https://weiming-hu.github.io/AnalogsEnsemble/2019/02/17/build-on-cheyenne.html">here</a>.</p>
<p>This tutorial also assumes that you have already built the <a class="el" href="class_an_en.html" title="AnEn is an abstract class that defines the interface for implement analog ensemble generation...">AnEn</a> tools. Instructions for building the tools can be found <a href="https://weiming-hu.github.io/AnalogsEnsemble/2019/02/17/build-on-cheyenne.html">here</a>.</p>
<h2>Data Preparation and Goals</h2>
<p><a class="el" href="struct_a.html">A</a> large collection (~5.4TB) of data from <a href="https://www.ncdc.noaa.gov/data-access/model-data/model-datasets/north-american-mesoscale-forecast-system-nam">North American Mesoscale Forecast model</a> have been downloaded for the time period from October, 2008, to July, 2018. The original files are <code>.g2.tar</code> files and an example for the file name is <code>nam_218_2008102900.g2.tar</code>. Files have already been arranged by <code>YearMonth</code> in each folder as follows:</p>
<div class="fragment"><div class="line">&gt; ls</div><div class="line">200810  200907  201004  201101  201110  201207  201304  201401  201410  201507  201604  201701  201710  201807</div><div class="line">200811  200908  201005  201102  201111  201208  201305  201402  201411  201508  201605  201702  201711  </div><div class="line">200812  200909  201006  201103  201112  201209  201306  201403  201412  201509  201606  201703  201712  </div><div class="line">200901  200910  201007  201104  201201  201210  201307  201404  201501  201510  201607  201704  201801  </div><div class="line">200902  200911  201008  201105  201202  201211  201308  201405  201502  201511  201608  201705  201802</div><div class="line">200903  200912  201009  201106  201203  201212  201309  201406  201503  201512  201609  201706  201803</div><div class="line">200904  201001  201010  201107  201204  201301  201310  201407  201504  201601  201610  201707  201804</div><div class="line">200905  201002  201011  201108  201205  201302  201311  201408  201505  201602  201611  201708  201805</div><div class="line">200906  201003  201012  201109  201206  201303  201312  201409  201506  201603  201612  201709  201806</div></div><!-- fragment --><p>Original NAM forecast files are organized by day, cycle time, and lead time. Each file is a compilation of parameters at all available locations/grid points. However, data that <a class="el" href="class_an_en.html" title="AnEn is an abstract class that defines the interface for implement analog ensemble generation...">AnEn</a> requires have a <a href="https://weiming-hu.github.io/AnalogsEnsemble/2019/01/16/NetCDF-File-Types.html#forecasts">different format</a>. This format requires the file to have parameters, grid points, times, and lead times information included. Our goal is convert the model output to this format.</p>
<p>Since the total file size exceeds 5 TB, it would be a better practice to avoid a huge file, but to have it broken down to chunks. Therefore, the files are grouped by month.</p>
<h2>Scripts</h2>
<p>I have prepared two scripts. The first script is the resource PBS script. This script does the following tasks:</p>
<ul>
<li>Identifies which folders are currently being processed by search for a lock file and which folders have already been processed by searching for the expected output data file;</li>
<li>Selects <em>only one</em> folder that has not yet been processed;</li>
<li>Untars tarballs in a temporary folder;</li>
<li>Convert submessages to independent messages using <code>grib_copy</code> (<a href="https://confluence.ecmwf.int/pages/viewpage.action?pageId=52462916#GRIBtoolsexamples-grib_copyexamples">reference: grib_copy example 4</a>);</li>
<li>Converts grb2 files to NetCDF files;</li>
<li>Computes and adds wind direction and speed fields to the NetCDF file;</li>
<li>Exits normally.</li>
</ul>
<div class="fragment"><div class="line">#!/bin/bash</div><div class="line"></div><div class="line"># The name of the task</div><div class="line">#PBS -N process_each_month</div><div class="line"></div><div class="line"># The project account</div><div class="line">#PBS -A MY.PROJECT.ACCOUNT</div><div class="line"></div><div class="line"># The time resources requested</div><div class="line">#PBS -l walltime=10:00:00</div><div class="line"></div><div class="line"># The queue type</div><div class="line">#PBS -q regular</div><div class="line"></div><div class="line"># Combine standard output and errors</div><div class="line">#PBS -j oe                           </div><div class="line"></div><div class="line"># The computing resources requested</div><div class="line">#PBS -l select=1:ncpus=1:mem=109GB:ompthreads=1</div><div class="line"></div><div class="line"># I would like to receive an email when tasks</div><div class="line"># (a)bort, (b)egin, and (e)nd.</div><div class="line">#</div><div class="line">#PBS -m abe</div><div class="line"></div><div class="line"># And this is the email</div><div class="line">#PBS -M my.email@server.com</div><div class="line"></div><div class="line"># These are the available folders. The folder names are also going to be the names of NetCDF files.</div><div class="line">declare -a arr=(&quot;200810&quot; &quot;200811&quot; &quot;200812&quot; &quot;200901&quot; &quot;200902&quot; &quot;200903&quot; &quot;200904&quot; &quot;200905&quot; &quot;200906&quot; &quot;200907&quot; &quot;200908&quot; &quot;200909&quot; &quot;200910&quot; &quot;200911&quot; &quot;200912&quot; &quot;201001&quot; &quot;201002&quot; &quot;201003&quot; &quot;201004&quot; &quot;201005&quot; &quot;201006&quot; &quot;201007&quot; &quot;201008&quot; &quot;201009&quot; &quot;201010&quot; &quot;201011&quot; &quot;201012&quot; &quot;201101&quot; &quot;201102&quot; &quot;201103&quot; &quot;201104&quot; &quot;201105&quot; &quot;201106&quot; &quot;201107&quot; &quot;201108&quot; &quot;201109&quot; &quot;201110&quot; &quot;201111&quot; &quot;201112&quot; &quot;201201&quot; &quot;201202&quot; &quot;201203&quot; &quot;201204&quot; &quot;201205&quot; &quot;201206&quot; &quot;201207&quot; &quot;201208&quot; &quot;201209&quot; &quot;201210&quot; &quot;201211&quot; &quot;201212&quot; &quot;201301&quot; &quot;201302&quot; &quot;201303&quot; &quot;201304&quot; &quot;201305&quot; &quot;201306&quot; &quot;201307&quot; &quot;201308&quot; &quot;201309&quot; &quot;201310&quot; &quot;201311&quot; &quot;201312&quot; &quot;201401&quot; &quot;201402&quot; &quot;201403&quot; &quot;201404&quot; &quot;201405&quot; &quot;201406&quot; &quot;201407&quot; &quot;201408&quot; &quot;201409&quot; &quot;201410&quot; &quot;201411&quot; &quot;201412&quot; &quot;201501&quot; &quot;201502&quot; &quot;201503&quot; &quot;201504&quot; &quot;201505&quot; &quot;201506&quot; &quot;201507&quot; &quot;201508&quot; &quot;201509&quot; &quot;201510&quot; &quot;201511&quot; &quot;201512&quot; &quot;201601&quot; &quot;201602&quot; &quot;201603&quot; &quot;201604&quot; &quot;201605&quot; &quot;201606&quot; &quot;201607&quot; &quot;201608&quot; &quot;201609&quot; &quot;201610&quot; &quot;201611&quot; &quot;201612&quot; &quot;201701&quot; &quot;201702&quot; &quot;201703&quot; &quot;201704&quot; &quot;201705&quot; &quot;201706&quot; &quot;201707&quot; &quot;201708&quot; &quot;201709&quot; &quot;201710&quot; &quot;201711&quot; &quot;201712&quot; &quot;201801&quot; &quot;201802&quot; &quot;201803&quot; &quot;201804&quot; &quot;201805&quot; &quot;201806&quot; &quot;201807&quot;)</div><div class="line"></div><div class="line"># Define the configuration file for gribConverter.</div><div class="line"># The file can be found at </div><div class="line"># https://github.com/Weiming-Hu/AnalogsEnsemble/blob/master/apps/app_gribConverter/example/commonConfig.cfg</div><div class="line">#</div><div class="line">converterConfig=/glade/u/home/wuh20/scratch/data/forecasts/forecasts.cfg</div><div class="line"></div><div class="line"># Define the output destination</div><div class="line">destDir=/glade/u/home/wuh20/flash/forecasts_new/</div><div class="line"></div><div class="line"># Define the lock file name</div><div class="line">lockFile=.lock</div><div class="line"></div><div class="line">for month in &quot;${arr[@]}&quot;; do</div><div class="line">    # This is the data folder</div><div class="line">    monthDir=/glade/u/home/wuh20/scratch/data/forecasts/$month</div><div class="line"></div><div class="line">    # Whether this folder has already been processed</div><div class="line">    if [ -f $destDir/$month\.nc  ]; then</div><div class="line">        echo Month $month has been processed. Skip this month.</div><div class="line">        continue</div><div class="line">    fi</div><div class="line"></div><div class="line">    # Check whether this directory exists</div><div class="line">    if [ ! -d $monthDir  ]; then</div><div class="line">        echo Directory not found: $monthDir</div><div class="line">        exit 1</div><div class="line">    fi</div><div class="line"></div><div class="line">    cd $monthDir</div><div class="line"></div><div class="line">    # Lock this directory</div><div class="line">    if [ -f $lockFile  ]; then</div><div class="line">        echo Directory $monthDir is in process. Skip this directory.</div><div class="line">        continue</div><div class="line">    else</div><div class="line">        echo Lock directory $monthDir</div><div class="line">        touch $lockFile</div><div class="line">    fi</div><div class="line"></div><div class="line">    # Create a folder to store the original files</div><div class="line">    if [ ! -d original-extract-files ]; then</div><div class="line">        echo Create folder for original extract files ...</div><div class="line">        mkdir original-extract-files</div><div class="line">    fi</div><div class="line"></div><div class="line">    # Unpack tar files</div><div class="line">    echo Extracting from tar files ...</div><div class="line">    if [ -f log_extract  ]; then</div><div class="line">        rm log_extract</div><div class="line">    fi</div><div class="line"></div><div class="line">    for tarFile in *.g2.tar; do</div><div class="line">        tar --skip-old-files -xvf $tarFile -C original-extract-files &gt;&gt; log_extract</div><div class="line">    done</div><div class="line"></div><div class="line">    echo flattening messages with submessages ...</div><div class="line">    for file in `ls original-extract-files`; do</div><div class="line">        if [ ! -f $file ]; then</div><div class="line">            /glade/u/home/wuh20/github/AnalogsEnsemble/dependency/install/bin/grib_copy original-extract-files/$file $file</div><div class="line">        fi</div><div class="line">    done</div><div class="line"></div><div class="line">    # Convert grb2 files</div><div class="line">    echo Converting grb2 files ...</div><div class="line">    if [ ! -f $month-original.nc ]; then</div><div class="line">        /glade/u/home/wuh20/github/AnalogsEnsemble/output/bin/gribConverter -c $converterConfig --folder ./ -o $month-original.nc -v 3 &gt; log_converter</div><div class="line">    fi</div><div class="line"></div><div class="line">    # Add wind fields</div><div class="line">    echo Adding wind fields ...</div><div class="line">    if [ ! -f $month\.nc ]; then</div><div class="line">        /glade/u/home/wuh20/github/AnalogsEnsemble/output/bin/windFieldCalculator --file-in $month-original.nc --file-type Forecasts --file-out $month\.nc -U 1000IsobaricInhPaU -V 1000IsobaricInhPaV --dir-name 1000IsobaricInhPaDir --speed-name 1000IsobaricInhPaSpeed -v 3 &gt; log_wind</div><div class="line">    fi</div><div class="line"></div><div class="line">    # Move the data file elsewhere</div><div class="line">    echo Moving data to $destDir</div><div class="line">    mv $month\.nc $destDir</div><div class="line"></div><div class="line">    # Cleaning</div><div class="line">    echo Cleaning ...</div><div class="line">    rm -rf original-extract-files</div><div class="line">    rm $month-original.nc</div><div class="line">    rm *.grb2</div><div class="line"></div><div class="line">    echo Releasing the folder lock</div><div class="line">    rm $lockFile</div><div class="line"></div><div class="line">    # Each job only process one month</div><div class="line">    echo Finished processing month $month</div><div class="line">    exit 0</div><div class="line">done</div></div><!-- fragment --><p>The first pbs script pretty much defines all the tasks that should be done. However, tasks for each month are entirely independent from each other and can be fully parallelized. Therefore, I decided that each task only processes one folder instead of continuing to the next folder available to avoid confusion between tasks. The following script simply deal with batch submitting the tasks to Cheyenne scheduler.</p>
<p>We have another problem here that if two tasks are started simultaneously, there is a slight possibility that they will process the same folder and the folder lock mechanism based on file creating might not work. <a class="el" href="struct_a.html">A</a> simple workaround for that is to ensure submitting a new job when there is no queueing tasks meaning all tasksing have been started.</p>
<p>``` #!/bin/bash</p>
<h1>Define the total number of jobs to create.</h1>
<p>totalJobs=118</p>
<h1>Define the counter start.</h1>
<p>submittedJobs=0</p>
<p>while true; do </p><h1>Get the number of queued jobs by looking at the queue status looking for the symbols</h1>
<p>number=<code>qstat | grep "Q regular" | wc -l</code></p>
<p>echo The number of queued jobs: $number echo The number of submitted jobs: $submittedJobs if (( number == 0 )); then echo There is no queued jobs. Submit a new one. qsub batch_process.pbs submittedJobs=$((submittedJobs + 1)) if (( submittedJobs == totalJobs )); then echo $submittedJobs jobs submitted. Done! exit 0 fi fi sleep 10 done </p><div class="fragment"><div class="line">## Results</div><div class="line"></div><div class="line">By the completion of the scripts, we would have the following files in our destination folder:</div></div><!-- fragment --> <blockquote class="doxtable">
<p>ls </p>
</blockquote>
<p>200810.nc 200910.nc 201010.nc 201110.nc 201210.nc 201310.nc 201410.nc 201510.nc 201610.nc 201710.nc 200811.nc 200911.nc 201011.nc 201111.nc 201211.nc 201311.nc 201411.nc 201511.nc 201611.nc 201711.nc 200812.nc 200912.nc 201012.nc 201112.nc 201212.nc 201312.nc 201412.nc 201512.nc 201612.nc 201712.nc 200901.nc 201001.nc 201101.nc 201201.nc 201301.nc 201401.nc 201501.nc 201601.nc 201701.nc 201801.nc 200902.nc 201002.nc 201102.nc 201202.nc 201302.nc 201402.nc 201502.nc 201602.nc 201702.nc 201802.nc 200903.nc 201003.nc 201103.nc 201203.nc 201303.nc 201403.nc 201503.nc 201603.nc 201703.nc 201803.nc 200904.nc 201004.nc 201104.nc 201204.nc 201304.nc 201404.nc 201504.nc 201604.nc 201704.nc 201804.nc 200905.nc 201005.nc 201105.nc 201205.nc 201305.nc 201405.nc 201505.nc 201605.nc 201705.nc 201805.nc 200906.nc 201006.nc 201106.nc 201206.nc 201306.nc 201406.nc 201506.nc 201606.nc 201706.nc 201806.nc 200907.nc 201007.nc 201107.nc 201207.nc 201307.nc 201407.nc 201507.nc 201607.nc 201707.nc 201807.nc 200908.nc 201008.nc 201108.nc 201208.nc 201308.nc 201408.nc 201508.nc 201608.nc 201708.nc 200909.nc 201009.nc 201109.nc 201209.nc 201309.nc 201409.nc 201509.nc 201609.nc 201709.nc </p><div class="fragment"><div class="line">And each file has the correct format for AnEn computation.</div></div><!-- fragment --> <blockquote class="doxtable">
<p>ncdump -h 201801.nc </p>
</blockquote>
<p>netcdf \201801 { dimensions: num_parameters = 17 ; num_chars = 50 ; num_stations = 262792 ; num_times = 31 ; num_flts = 53 ; variables: char ParameterNames(num_parameters, num_chars) ; double ParameterWeights(num_parameters) ; char ParameterCirculars(num_parameters, num_chars) ; char StationNames(num_stations, num_chars) ; double Xs(num_stations) ; double Ys(num_stations) ; double <a class="el" href="class_times.html" title="Times class is used to store Time. It is a bidirectional map implemented from Boost so that it provid...">Times(num_times)</a> ; double FLTs(num_flts) ; double Data(num_flts, num_times, num_stations, num_parameters) ; } ``` </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
