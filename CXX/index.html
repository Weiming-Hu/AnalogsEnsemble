---
sidebar_link: true
title: C++ Documentation
---


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ParallelAnalogEnsemble: &lt;a href=&quot;https://weiming-hu.github.io/AnalogsEnsemble/&quot;&gt;PAnEn: Parallel Analog Ensemble&lt;/a&gt;</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ParallelAnalogEnsemble
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title"><a href="https://weiming-hu.github.io/AnalogsEnsemble/">PAnEn: Parallel Analog Ensemble</a> </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a href="https://zenodo.org/badge/latestdoi/130093968"><object type="image/svg+xml" data="https://zenodo.org/badge/130093968.svg" style="pointer-events: none;">DOI</object></a> <a href="https://opensource.org/licenses/MIT"><object type="image/svg+xml" data="https://img.shields.io/badge/License-MIT-yellow.svg" style="pointer-events: none;">License: MIT</object></a> <a href="https://www.codacy.com/gh/Weiming-Hu/AnalogsEnsemble/dashboard?utm_source=github.com&amp;utm_medium=referral&amp;utm_content=Weiming-Hu/AnalogsEnsemble&amp;utm_campaign=Badge_Grade"><img src="https://app.codacy.com/project/badge/Grade/e4b8f97d5f3a41029741579f648c8e38" alt="Codacy Badge" class="inline"/></a> <a href="https://github.com/Weiming-Hu/AnalogsEnsemble/actions?query=workflow%3A%22Build+C%2B%2B%22"><object type="image/svg+xml" data="https://github.com/Weiming-Hu/AnalogsEnsemble/workflows/Build%20C++/badge.svg" style="pointer-events: none;">Build C++</object></a> <a href="https://github.com/Weiming-Hu/AnalogsEnsemble/actions/workflows/BuildR.yml"><object type="image/svg+xml" data="https://github.com/Weiming-Hu/AnalogsEnsemble/actions/workflows/BuildR.yml/badge.svg" style="pointer-events: none;">Build R</object></a> <a href="https://codecov.io/gh/Weiming-Hu/AnalogsEnsemble"><object type="image/svg+xml" data="https://codecov.io/gh/Weiming-Hu/AnalogsEnsemble/branch/master/graph/badge.svg?token=tcGGOTyHHk" style="pointer-events: none;">codecov</object></a> <a href="https://www.tidyverse.org/lifecycle/#experimental"><object type="image/svg+xml" data="https://img.shields.io/badge/lifecycle-experimental-orange.svg" style="pointer-events: none;">lifecycle</object></a> <a href="https://mybinder.org/v2/gh/Weiming-Hu/AnalogsEnsemble/master?urlpath=rstudio"><object type="image/svg+xml" data="https://mybinder.org/badge.svg" style="pointer-events: none;">Binder</object></a> <a href="https://hub.docker.com/r/weiminghu123/panen"><img src="https://dockeri.co/image/weiminghu123/panen" alt="dockeri.co" class="inline"/></a></p>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#citation">Citation</a></li>
<li><a href="#installation">Installation</a><ul>
<li><a href="#ranen">RAnEn</a></li>
<li><a href="#canen">CAnEn</a></li>
<li><a href="#cmake-parameters">CMake Parameters</a></li>
<li><a href="#high-performance-computing-and-supercomputers">High-Performance Computing and Supercomputers</a></li>
<li><a href="#mpi-and-openmp">MPI and OpenMP</a></li>
</ul>
</li>
<li><a href="#tutorials">Tutorials</a></li>
<li><a href="#references">References</a></li>
<li><a href="#feedbacks">Feedbacks</a></li>
</ul>
<h1>Overview</h1>
<p>Parallel Analog Ensemble (PAnEn) generates accurate forecast ensembles relying on a single deterministic model simulation and the historical observations. The technique was introduced by Luca Delle Monache et al. in the paper <a href="https://journals.ametsoc.org/doi/full/10.1175/MWR-D-12-00281.1">Probabilistic Weather Prediction with an Analog Ensemble</a>. Developed and maintained by <a href="http://geolab.psu.edu">GEOlab</a> at Penn State, PAnEn aims to provide an efficient implementation for this technique and user-friendly interfaces in R and C++ for researchers who want to use this technique in their own research.</p>
<p>The easiest way to use this package is to install the R package, 'RAnEn'. C++ libraries are also available but they are designed for intermediate users with requirement for performance. For installation guidance, please refer to the <a href="#installation">installation section</a>.</p>
<h1>Citation</h1>
<p>To cite this package, you have several options:</p>
<ul>
<li>Using <code>LaTex</code>: Please use <a href="https://github.com/Weiming-Hu/AnalogsEnsemble/blob/master/RAnalogs/RAnEn/inst/CITATION">this file</a> for citation.</li>
<li>Using <code>R</code>: Simply type &lsquo;citation('RAnEn&rsquo;)` and the citation message will be printed.</li>
<li>Using plain text: Please use the following citation format:</li>
</ul>
<div class="fragment"><div class="line">Weiming Hu, Guido Cervone, Laura Clemente-Harding, and Martina Calovi. (2019). Parallel Analog Ensemble. Zenodo. http://doi.org/10.5281/zenodo.3384321</div>
</div><!-- fragment --><h1>Installation</h1>
<p><code>RAnEn</code> is very easy to install if you are already using <a href="https://www.r-project.org/">R</a>. This is the recommended way to start.</p>
<h2>RAnEn</h2>
<p><em>The command is the same for <code>RAnEn</code> installation and update.</em></p>
<p>To install <code>RAnEn</code>, please install the following packages first:</p>
<ul>
<li><a href="https://cran.r-project.org/web/packages/BH/index.html">BH</a>: &lsquo;install.packages('BH&rsquo;)<code></code></li>
<li><code>[Rcpp](<a href="https://cran.r-project.org/web/packages/Rcpp/index.html">https://cran.r-project.org/web/packages/Rcpp/index.html</a>):</code>install.packages('Rcpp')<code></code></li>
<li><code>If you are using</code>Windows`, please also install the latest version of <a href="https://cran.r-project.org/bin/windows/Rtools/">Rtools</a>.</li>
</ul>
<p>The following R command install the latest <code>RAnEn</code>.</p>
<div class="fragment"><div class="line">install.packages(&quot;https://github.com/Weiming-Hu/AnalogsEnsemble/raw/master/RAnalogs/releases/RAnEn_latest.tar.gz&quot;, repos = NULL)</div>
</div><!-- fragment --><p>That's it. You are good to go. Please refer to <a href="#tutorials">tutorials</a> or the <a href="https://weiming-hu.github.io/AnalogsEnsemble/R/">R documentation</a> to learn more about using <code>RAnEn</code>. You might also want to install <a href="https://github.com/Weiming-Hu/RAnEnExtra">RAnEnExtra</a> package with functions for visualization and verification. After <code>RAnEn</code> installation, you can simply run <code>devtools::install_github("Weiming-Hu/RAnEnExtra")</code>.</p>
<p><b>Mac users</b>: if the package shows that <code>OpenMP</code> is not supported. You can do one of the followings:</p>
<ol type="1">
<li>Avoid using Clang compilers and convert to GNU compilers. To change the compilers used by R, create a file <code>~/.R/Makevars</code> if you do not have it already and add the following content to it. Of course, change the compilers to what you have. If you do not have any alternative compilers other than Clang, <a href="https://brew.sh/">HomeBrew</a> is your friend.</li>
</ol>
<div class="fragment"><div class="line">CC=gcc-8</div>
<div class="line">CXX=g++-8</div>
<div class="line">CXX1X=g++-8</div>
<div class="line">CXX14=g++-8</div>
</div><!-- fragment --><ol type="1">
<li>You can also follow the instructions <a href="https://github.com/Rdatatable/data.table/wiki/Installation#openmp-enabled-compiler-for-mac">here</a> provided by <code>data.table</code>. They provide similar solutions but stick with Clang compilers.</li>
</ol>
<p>After the installation, you can always revert back to your original setup and <code>RAnEn</code> will stay supported by <code>OpenMP</code>.</p>
<h2>CAnEn</h2>
<p>To install the C++ libraries, please check the following dependencies:</p>
<ul>
<li><em>Required</em> <a href="https://cmake.org/">CMake</a> is the required build system generator.</li>
<li><em>Required</em> <a href="https://www.unidata.ucar.edu/downloads/netcdf/">NetCDF</a> provides the file I/O with NetCDF files.</li>
<li><em>Required</em> <a href="https://confluence.ecmwf.int/display/ECC/ecCodes+installation">Eccodes</a> provides the file I/O with Grib2 files.</li>
<li><em>Optional</em> <a href="https://www.boost.org/">Boost</a> provides high-performance data structures. <code>Boost</code> is a very large library. If you don't want to install the entire package, <code>PAnEn</code> is able to build the required ones automatically.</li>
<li><em>Optional</em> <code>CppUnit</code> provides test frameworks. If <code>CppUnit</code> is found in the system, test programs will be compiled.</li>
</ul>
<p>Please use the following scripts to install the libraries:</p>
<div class="fragment"><div class="line"># Download the source files (~10 Mb)</div>
<div class="line">wget https://github.com/Weiming-Hu/AnalogsEnsemble/archive/master.zip</div>
<div class="line"> </div>
<div class="line"># Unzip</div>
<div class="line">unzip master.zip</div>
<div class="line"> </div>
<div class="line"># Create a separate folder to store all intermediate files during the installation process</div>
<div class="line">cd AnalogsEnsemble-master/</div>
<div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">cmake -DCMAKE_INSTALL_PREFIX=~/AnalogEnsemble ..</div>
<div class="line"> </div>
<div class="line"># Compile</div>
<div class="line">make -j 4</div>
<div class="line"> </div>
<div class="line"># Install</div>
<div class="line">make install</div>
</div><!-- fragment --><h2>CMake <a class="el" href="class_parameters.html" title="Parameters class stores Parameter objects. It is a bidirectional map implemented from Boost so that i...">Parameters</a></h2>
<p>Below is a list of parameters you can change and customize.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter"><a class="el" href="class_parameter.html" title="Parameter stores parameter information including name and circular.">Parameter</a> </th><th class="markdownTableHeadCenter">Explanation </th><th class="markdownTableHeadCenter">Default  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">CMAKE_C_COMPILER </td><td class="markdownTableBodyCenter">The C compiler to use. </td><td class="markdownTableBodyCenter">[System dependent]  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">CMAKE_CXX_COMPILER </td><td class="markdownTableBodyCenter">The C++ compiler to use. </td><td class="markdownTableBodyCenter">[System dependent]  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">CMAKE_INSTALL_PREFIX </td><td class="markdownTableBodyCenter">The installation directory. </td><td class="markdownTableBodyCenter">[System dependent]  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">CMAKE_PREFIX_PATH </td><td class="markdownTableBodyCenter">Which folder(s) should cmake search for packages besides the default. Paths are surrounded by double quotes and separated with semicolons. </td><td class="markdownTableBodyCenter">[Empty]  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">CMAKE_INSTALL_RPATH </td><td class="markdownTableBodyCenter">The run-time library path. Paths are surrounded by double quotes and separated with semicolons. </td><td class="markdownTableBodyCenter">[Empty]  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">CMAKE_BUILD_TYPE </td><td class="markdownTableBodyCenter"><code>Release</code> for release mode; <code>Debug</code> for debug mode. </td><td class="markdownTableBodyCenter">Release  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">INSTALL_RAnEn </td><td class="markdownTableBodyCenter">Build and install the <code>RAnEn</code> library. </td><td class="markdownTableBodyCenter">OFF  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">BUILD_BOOST </td><td class="markdownTableBodyCenter">Build <code>Boost</code> regardless of whether it exists in the system. </td><td class="markdownTableBodyCenter">OFF  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">BOOST_URL </td><td class="markdownTableBodyCenter">The URL for downloading Boost. This is only used when <code>BUILD_BOOST</code> is <code>ON</code>. </td><td class="markdownTableBodyCenter">[From SourceForge]  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">ENABLE_MPI </td><td class="markdownTableBodyCenter">Build the MPI supported libraries and executables. This requires the MPI dependency. </td><td class="markdownTableBodyCenter">OFF  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">ENABLE_OPENMP </td><td class="markdownTableBodyCenter">Enable multi-threading with OpenMP </td><td class="markdownTableBodyCenter">ON  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">ENABLE_AI </td><td class="markdownTableBodyCenter">Enable PyTorch integration and the power of AI. </td><td class="markdownTableBodyCenter">OFF  </td></tr>
</table>
<p>You can change the default of the parameters, for example, <code>cmake -DCMAKE_INSTALL_PREFIX=~/AnalogEnsemble ..</code>. Don't forget the extra letter <code>D</code> when specifying argument names.</p>
<h2>High-Performance Computing and Supercomputers</h2>
<p><a href="https://github.com/Weiming-Hu/AnalogsEnsemble/issues/86">Here</a> is a list of instructions to build and install <code><a class="el" href="class_an_en.html" title="AnEn is an abstract class that defines the interface for implement analog ensemble generation.">AnEn</a></code> on supercomputers.</p>
<h2>MPI and OpenMP</h2>
<div class="fragment"><div class="line">TL;DR</div>
<div class="line"> </div>
<div class="line">Launching an MPI-OpenMP hybrid program can be tricky.</div>
<div class="line"> </div>
<div class="line">If the performance with MPI is acceptable,</div>
<div class="line">disable OpenMP (`cmake -DENABLE_OPENMP=OFF ..`).</div>
<div class="line"> </div>
<div class="line">If the hybrid solution is desired,</div>
<div class="line">make sure you have the proper setup.</div>
</div><!-- fragment --><p>When <code>ENABLE_MPI</code> is turned on, MPI programs will be built. These MPI programs are hybrid programs (unless you set <code>-DENABLE_OPENMP=OFF</code> for <code>cmake</code>) that use both MPI and OpenMP. Please check with your individual supercomputer platform to find out <b>what the proper configuration for launching an MPI + OpenMP hybrid program is</b>. Users are responsible not to launch too many process and threads at the same time which would overtask the machine and might lead to hanging problems (as what I have seen on <a href="https://portal.tacc.utexas.edu/user-guides/stampede2">XSEDE Stampede2</a>).</p>
<p>On <a href="https://www2.cisl.ucar.edu/resources/computational-systems/cheyenne">NCAR Cheyenne</a>, the proper way to launch a hybrid program can be found <a href="https://www2.cisl.ucar.edu/resources/computational-systems/cheyenne/running-jobs/pbs-pro-job-script-examples">here</a>. If you use <code>mpirun</code>, instead of <code>mpiexec_mpt</code>, you will loose the multi-threading performance improvement.</p>
<p>To dive deeper into the hybrid parallelization design, MPI is used for computationally expensive portions of the code, e.g. file I/O and analog generation while OpenMP is used by the master process during bottleneck portion of the code, e.g. data reshaping and information queries.</p>
<p>When analogs with a long search and test periods are desired, MPI is used to distribute forecast files across processes. Each process reads a subset of the forecast files. This solves the problem where serial I/O can be very slow.</p>
<p>When a large number of stations/grids present, MPI is used to distribute analog generation for different stations across processes. Each process takes charge of generating analogs for a subset of stations.</p>
<p>Sitting between the file I/O and the analog generation is the bottleneck which is hard to parallelize with MPI, e.g. reshaping the data and querying test/search times. Therefore, they are parallelized with OpenMP on master process only.</p>
<p>So if the platform support heterogeneous task layout, users can theoretically allocate one core per worker process and more cores for the master process to facilitate its multi-threading scope. But again, only do this when you find the bottleneck is taking much longer time than file I/O and analog generation. Use <code>--profile</code> to have profiling information in standard message output.</p>
<h1>Tutorials</h1>
<p>Tutorials can be accessed on <a href="https://mybinder.org/v2/gh/Weiming-Hu/AnalogsEnsemble/master?urlpath=rstudio">binder</a> or be found in <a href="https://github.com/Weiming-Hu/AnalogsEnsemble/tree/master/RAnalogs/examples">this directory</a></p>
<p>Here are also some tips and caveats in <a href="https://github.com/Weiming-Hu/AnalogsEnsemble/issues/81">this ticket</a>.</p>
<h1>References</h1>
<ul>
<li><a href="https://journals.ametsoc.org/doi/full/10.1175/MWR-D-12-00281.1">Delle Monache, Luca, et al. "Probabilistic weather prediction with an analog ensemble." Monthly Weather Review 141.10 (2013): 3498-3516.</a></li>
<li><a href="https://ral.ucar.edu/sites/default/files/public/images/events/WISE_documentation_20170725_Final.pdf">Clemente-Harding, L. A Beginners Introduction to the Analog Ensemble Technique</a></li>
<li><a href="https://www.sciencedirect.com/science/article/pii/S0960148117301386">Cervone, Guido, et al. "Short-term photovoltaic power forecasting using Artificial Neural Networks and an Analog Ensemble." Renewable energy 108 (2017): 274-286.</a></li>
<li><a href="https://www.researchgate.net/profile/Constantin_Junk/publication/274951815_Predictor-weighting_strategies_for_probabilistic_wind_power_forecasting_with_an_analog_ensemble/links/552cd5710cf29b22c9c47260.pdf">Junk, Constantin, et al. "Predictor-weighting strategies for probabilistic wind power forecasting with an analog ensemble." Meteorol. Z 24.4 (2015): 361-379.</a></li>
<li><a href="https://ieeexplore.ieee.org/abstract/document/8425207">Balasubramanian, Vivek, et al. "Harnessing the power of many: Extensible toolkit for scalable ensemble applications." 2018 IEEE International Parallel and Distributed Processing Symposium (IPDPS). IEEE, 2018.</a></li>
<li><a href="https://www.sciencedirect.com/science/article/pii/S0098300418306678">Hu, Weiming, and Guido Cervone. "Dynamically Optimized Unstructured Grid (DOUG) for Analog Ensemble of numerical weather predictions using evolutionary algorithms." Computers &amp; Geosciences 133 (2019): 104299.</a></li>
</ul>
<h1>Feedbacks</h1>
<p>We appreciate collaborations and feedbacks from users. Please contact the maintainer <a href="https://weiming-hu.github.io">Weiming Hu</a> through <a href="weiming@psu.edu">weiming@psu.edu</a> or submit tickets if you have any problems.</p>
<p>Thank you!</p>
<div class="fragment"><div class="line"># &quot;`-&#39;&#39;-/&quot;).___..--&#39;&#39;&quot;`-._</div>
<div class="line">#  (`6_ 6  )   `-.  (     ).`-.__.`)   WE ARE ...</div>
<div class="line">#  (_Y_.)&#39;  ._   )  `._ `. ``-..-&#39;    PENN STATE!</div>
<div class="line">#    _ ..`--&#39;_..-_/  /--&#39;_.&#39; ,&#39;</div>
<div class="line">#  (il),-&#39;&#39;  (li),&#39;  ((!.-&#39;</div>
<div class="line"># </div>
<div class="line"># Authors: </div>
<div class="line">#     Weiming Hu &lt;weiming@psu.edu&gt;</div>
<div class="line">#     Guido Cervone &lt;cervone@psu.edu&gt;</div>
<div class="line">#     Laura Clemente-Harding &lt;lec170@psu.edu&gt;</div>
<div class="line">#     Martina Calovi &lt;mcalovi@psu.edu&gt;</div>
<div class="line">#</div>
<div class="line"># Contributors: </div>
<div class="line">#     Luca Delle Monache</div>
<div class="line">#         </div>
<div class="line"># Geoinformatics and Earth Observation Laboratory (http://geolab.psu.edu)</div>
<div class="line"># Department of Geography and Institute for CyberScience</div>
<div class="line"># The Pennsylvania State University</div>
</div><!-- fragment --> </div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
